{% extends 'userindex.html' %}
{% load static %}

{% block content %}
<div class="hero-wrap" style="background-image: url('{{ package.image.url }}');">
    <div class="overlay"></div>
    <div class="container">
        <div class="row no-gutters slider-text d-flex align-items-end justify-content-center">
            <div class="col-md-9 ftco-animate text-center">
                <h1 class="mb-0 bread">Book {{ package.name }}</h1>
                <p class="breadcrumbs">
                    <span class="mr-2"><a href="{% url 'userindex' %}">Home</a></span>
                    <span>Booking</span>
                </p>
            </div>
        </div>
    </div>
</div>

<section class="ftco-section bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow border-0">
                    <div class="card-body p-5">
                        <h2 class="text-center mb-4">Book Your Dream Package</h2>
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: 33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100">Step 1</div>
                        </div>
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                            {% endfor %}
                        {% endif %}
                        <form id="bookingForm" action="{% url 'process_booking' package.id %}" method="POST">
                            {% csrf_token %}
                            
                            <div class="tab-content" id="bookingTabContent">
                                <!-- Step 1: Personal Information -->
                                <div class="tab-pane fade show active" id="personal-info" role="tabpanel">
                                    <h3 class="mb-4">Personal Information</h3>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="full_name">Full Name</label>
                                            <input type="text" class="form-control" id="full_name" name="full_name" required>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="phone">Mobile Number</label>
                                            <input type="tel" class="form-control" id="phone" name="phone" required>
                                            <small class="form-text text-muted">Please enter a valid mobile number.</small>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="email">Email</label>
                                            <input type="email" class="form-control" id="email" name="email" required>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="address">Address</label>
                                            <input type="text" class="form-control" id="address" name="address" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step 2: Booking Details -->
                                <div class="tab-pane fade" id="booking-details" role="tabpanel">
                                    <h3 class="mb-4">Booking Details</h3>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="num_adults">Number of Adults</label>
                                            <input type="number" class="form-control" id="num_adults" name="num_adults" min="1" required>
                                            <div class="invalid-feedback">Please enter the number of adults.</div>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="num_children">Number of Children</label>
                                            <input type="number" class="form-control" id="num_children" name="num_children" min="0" required>
                                            <div class="invalid-feedback">Please enter the number of children.</div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="food_preference">Food Preference</label>
                                        <select name="food_preference" id="food_preference" class="form-control" required>
                                            <option value="">Select Food Preference</option>
                                            <option value="veg">Vegetarian</option>
                                            <option value="non-veg">Non-Vegetarian</option>
                                        </select>
                                        <div class="invalid-feedback">Please select a food preference.</div>
                                    </div>
                                    <div class="form-group">
                                        <label>Add-ons</label>
                                        <div class="addon-options">
                                            {% for addon in addons %}
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="addons" id="addon{{ addon.id }}" value="{{ addon.id }}">
                                                <label class="form-check-label" for="addon{{ addon.id }}">
                                                    {{ addon.name }} - â‚¹{{ addon.price }}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <!-- Add this inside the "Booking Details" section -->
                                    <div class="form-group">
                                        <label for="booking_date">Booking Date</label>
                                        <input type="date" class="form-control" id="booking_date" name="booking_date" required min="{{ tomorrow_date|date:'Y-m-d' }}">
                                        <div class="invalid-feedback">Please select a booking date.</div>
                                    </div>
                                </div>
                                
                                <!-- Step 3: Payment -->
                                <div class="tab-pane fade" id="payment" role="tabpanel">
                                    <h3 class="mb-4">Payment</h3>
                                    <div class="form-group">
                                        <label for="total_amount">Total Amount</label>
                                        <input type="text" class="form-control" id="total_amount" name="total_amount" readonly>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-block mt-4" id="payNowBtn" onclick="processPayment()">Pay Now</button>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" id="prevBtn" onclick="nextPrev(-1)">Previous</button>
                                <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextPrev(1)">Next</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .progress {
        height: 5px;
    }
    .progress-bar {
        background-color: #4CAF50;
    }
    .card {
        border-radius: 15px;
    }
    .form-control {
        border-radius: 20px;
    }
    .btn {
        border-radius: 20px;
        padding: 10px 20px;
    }
    .btn-primary {
        background-color: #4CAF50;
        border-color: #4CAF50;
    }
    .btn-primary:hover {
        background-color: #45a049;
        border-color: #45a049;
    }
    .payment-options {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
    }
    .payment-options .form-check {
        flex-basis: calc(50% - 15px);
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        transition: all 0.3s ease;
    }
    .payment-options .form-check:hover {
        background-color: #e9ecef;
    }
    .payment-options .form-check-input {
        margin-top: 0.3rem;
    }
    .payment-options .form-check-label {
        display: flex;
        align-items: center;
        font-weight: 500;
    }
    .payment-options .form-check-label i {
        font-size: 1.5rem;
        margin-right: 10px;
    }
    #payNowBtn {
        font-size: 1.1rem;
        padding: 12px 20px;
    }
    .addon-options {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
    }
    .addon-options .form-check {
        flex-basis: calc(50% - 15px);
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        transition: all 0.3s ease;
    }
    .addon-options .form-check:hover {
        background-color: #e9ecef;
    }
    .addon-options .form-check-input {
        margin-top: 0.3rem;
    }
    .addon-options .form-check-label {
        display: flex;
        align-items: center;
        font-weight: 500;
    }
</style>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    var currentTab = 0;
    showTab(currentTab);

    function showTab(n) {
        var x = document.getElementsByClassName("tab-pane");
        x[n].classList.add("show", "active");
        if (n == 0) {
            document.getElementById("prevBtn").style.display = "none";
        } else {
            document.getElementById("prevBtn").style.display = "inline";
        }
        if (n == (x.length - 1)) {
            document.getElementById("nextBtn").style.display = "none";
            document.getElementById("payNowBtn").style.display = "block";
        } else {
            document.getElementById("nextBtn").style.display = "inline";
            document.getElementById("payNowBtn").style.display = "none";
        }
        updateProgressBar(n);
        updateTotalAmount();
    }

    function nextPrev(n) {
        var x = document.getElementsByClassName("tab-pane");
        if (n == 1 && !validateForm()) return false;
        x[currentTab].classList.remove("show", "active");
        currentTab += n;
        if (currentTab >= x.length) {
            return false;
        }
        showTab(currentTab);
    }

    function validateForm() {
        var x, y, i, valid = true;
        x = document.getElementsByClassName("tab-pane");
        y = x[currentTab].getElementsByTagName("input");
        for (i = 0; i < y.length; i++) {
            if (y[i].value == "" && y[i].hasAttribute('required')) {
                y[i].classList.add("is-invalid");
                valid = false;
            } else {
                y[i].classList.remove("is-invalid");
            }
        }
        var selects = x[currentTab].getElementsByTagName("select");
        for (i = 0; i < selects.length; i++) {
            if (selects[i].value == "" && selects[i].hasAttribute('required')) {
                selects[i].classList.add("is-invalid");
                valid = false;
            } else {
                selects[i].classList.remove("is-invalid");
            }
        }
        if (!valid) {
            alert("Please fill in all required fields.");
        }
        return valid;
    }

    function updateProgressBar(n) {
        var progress = document.querySelector('.progress-bar');
        var percentage = ((n + 1) / 3) * 100;
        progress.style.width = percentage + '%';
        progress.setAttribute('aria-valuenow', percentage);
        progress.innerHTML = 'Step ' + (n + 1);
    }

    function updateTotalAmount() {
        var numAdults = document.getElementById("num_adults").value || 0;
        var numChildren = document.getElementById("num_children").value || 0;
        var packagePrice = {{ package.price }};

        var totalAmount = (parseInt(numAdults) + (parseInt(numChildren) * 0.5)) * parseFloat(packagePrice);

        // Calculate add-ons
        var addons = document.querySelectorAll('input[name="addons"]:checked');
        addons.forEach(function(addon) {
            totalAmount += parseFloat(addon.value);
        });

        document.getElementById("total_amount").value = totalAmount.toFixed(2);
    }

    function processPayment() {
        if (!validateForm()) {
            return false;
        }

        var formData = new FormData(document.getElementById('bookingForm'));
        
        // Log form data
        for (var pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }

        fetch("{% url 'process_booking' package.id %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Server response:', text);
                    throw new Error('Network response was not ok: ' + response.statusText + '\n' + text);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                console.error('Server error:', data.error);
                throw new Error(data.error);
            }
            console.log('Server response:', data);
            var options = {
                "key": data.key,
                "amount": data.amount,
                "currency": data.currency,
                "name": "{{ package.name }}",
                "description": "Booking for {{ package.name }}",
                "order_id": data.order_id,
                "handler": function (response){
                    fetch("{% url 'payment_callback' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(response)
                    })
                    .then(res => res.json())
                    .then(data => {
                        if(data.status === 'success') {
                            window.location.href = "{% url 'booking_confirmation' 0 %}".replace('0', data.booking_id);
                        } else {
                            alert('Payment failed. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error in payment callback:', error);
                        alert('An error occurred during payment confirmation. Please contact support.');
                    });
                },
                "prefill": {
                    "name": document.getElementById('full_name').value,
                    "email": document.getElementById('email').value,
                    "contact": document.getElementById('phone').value
                },
                "theme": {
                    "color": "#4CAF50"
                }
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred: ' + error.message);
        });
    }

    // Add event listeners to update total amount when inputs change
    document.getElementById("num_adults").addEventListener("change", updateTotalAmount);
    document.getElementById("num_children").addEventListener("change", updateTotalAmount);

    // Add event listeners for add-ons
    var addonCheckboxes = document.querySelectorAll('input[name="addons"]');
    addonCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', updateTotalAmount);
    });

    // Add this to your existing event listeners
    document.getElementById("booking_date").addEventListener("change", function() {
        this.classList.remove("is-invalid");
    });

    function setMinBookingDate() {
        var tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        var dd = String(tomorrow.getDate()).padStart(2, '0');
        var mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
        var yyyy = tomorrow.getFullYear();
        var minDate = yyyy + '-' + mm + '-' + dd;
        document.getElementById('booking_date').min = minDate;
    }

    document.addEventListener('DOMContentLoaded', function() {
        setMinBookingDate();
        // ... (keep existing code)
    });
</script>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Remove readonly attributes and allow editing of all fields
    var inputs = document.querySelectorAll('input, select');
    inputs.forEach(function(input) {
        input.removeAttribute('readonly');
    });

    // Add event listeners to remove is-invalid class on input
    inputs.forEach(function(input) {
        input.addEventListener('input', function() {
            this.classList.remove('is-invalid');
        });
    });

    // Validation function (already defined in the main script)
    // ... (keep the existing validateForm function) ...
});
</script>
{% endblock %}