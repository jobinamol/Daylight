{% extends 'adminindex.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4 text-center">Create Daycation Package</h1>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="bg-white p-4 rounded shadow" id="packageForm">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="name" class="form-label">Package Name</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="col-md-6 mb-3">
                <label for="category" class="form-label">Category</label>
                <select class="form-select" id="category" name="category" required>
                    <option value="" selected disabled>Select a category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="price" class="form-label">Price (₹)</label>
                <input type="number" step="0.01" class="form-control" id="price" name="price" required min="0">
            </div>
            <div class="col-md-4 mb-3">
                <label for="duration" class="form-label">Duration</label>
                <input type="text" class="form-control" id="duration" name="duration" required placeholder="e.g., 2 hours, 1 day">
            </div>
            <div class="col-md-4 mb-3">
                <label for="max_capacity" class="form-label">Max Capacity</label>
                <input type="number" class="form-control" id="max_capacity" name="max_capacity" required min="1">
            </div>
        </div>

        <div class="mb-3">
            <label for="image" class="form-label">Package Image</label>
            <input type="file" class="form-control" id="image" name="image" accept="image/*">
        </div>
        
        <h3 class="mt-4">Features</h3>
        <div id="features">
            <div class="mb-2">
                <input type="text" class="form-control" name="features[]" placeholder="Feature">
            </div>
        </div>
        <button type="button" class="btn btn-outline-secondary mb-3" onclick="addFeature()">
            <i class="fas fa-plus"></i> Add Feature
        </button>

        <h3 class="mt-4">Add-ons</h3>
        <div id="addons">
            <div class="card mb-3">
                <div class="card-body">
                    <input type="text" class="form-control mb-2" name="addon_name[]" placeholder="Add-on Name">
                    <div class="input-group mb-2">
                        <span class="input-group-text">₹</span>
                        <input type="number" step="0.01" class="form-control" name="addon_price[]" placeholder="Add-on Price" min="0">
                    </div>
                    <textarea class="form-control" name="addon_description[]" placeholder="Add-on Description" rows="2"></textarea>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-outline-secondary mb-3" onclick="addAddon()">
            <i class="fas fa-plus"></i> Add Add-on
        </button>

        <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg mt-4">Create Package</button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
<script>
function addFeature() {
    const featuresDiv = document.getElementById('features');
    const newFeature = document.createElement('div');
    newFeature.className = 'input-group mb-2';
    newFeature.innerHTML = `
        <input type="text" class="form-control" name="features[]" placeholder="Feature">
        <button class="btn btn-outline-danger" type="button" onclick="removeElement(this)">
            <i class="fas fa-trash"></i>
        </button>
    `;
    featuresDiv.appendChild(newFeature);
}

function addAddon() {
    const addonsDiv = document.getElementById('addons');
    const newAddon = document.createElement('div');
    newAddon.className = 'card mb-3';
    newAddon.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <input type="text" class="form-control me-2" name="addon_name[]" placeholder="Add-on Name">
                <button class="btn btn-outline-danger" type="button" onclick="removeElement(this.parentNode.parentNode.parentNode)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="input-group mb-2">
                <span class="input-group-text">₹</span>
                <input type="number" step="0.01" class="form-control" name="addon_price[]" placeholder="Add-on Price" min="0">
            </div>
            <textarea class="form-control" name="addon_description[]" placeholder="Add-on Description" rows="2"></textarea>
        </div>
    `;
    addonsDiv.appendChild(newAddon);
}

function removeElement(element) {
    element.remove();
}

document.getElementById('packageForm').addEventListener('submit', function(event) {
    const features = document.querySelectorAll('input[name="features[]"]');
    const addons = document.querySelectorAll('input[name="addon_name[]"]');
    
    if (features.length === 0) {
        alert('Please add at least one feature.');
        event.preventDefault();
        return;
    }

    let valid = true;
    features.forEach(feature => {
        if (!feature.value.trim()) {
            alert('Please fill in all feature fields or remove empty ones.');
            event.preventDefault();
            valid = false;
            return;
        }
    });

    if (!valid) return;

    addons.forEach((addon, index) => {
        const price = document.querySelectorAll('input[name="addon_price[]"]')[index];
        const description = document.querySelectorAll('textarea[name="addon_description[]"]')[index];
        if (addon.value.trim() || price.value.trim() || description.value.trim()) {
            if (!addon.value.trim() || !price.value.trim() || !description.value.trim()) {
                alert('Please fill in all fields for each add-on or remove incomplete ones.');
                event.preventDefault();
                return;
            }
        }
    });
});
</script>
{% endblock %}
